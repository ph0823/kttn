<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bảng điểm học sinh</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 28px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      display: none; /* ẨN bảng khi chưa chọn lớp */
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th { background: #f2f2f2; }

    select {
      padding: 8px;
      font-size: 16px;
      margin-left: 10px;
    }

    .missing-box {
      margin-top: 25px;
      padding: 15px;
      border: 2px dashed red;
      background: #ffecec;
      display: none; /* Ẩn khi chưa chọn lớp */
    }
  </style>
</head>
<body>

<h1>Bảng điểm học sinh</h1>

<label><b>Lọc theo lớp:</b></label>
<select id="lop-filter">
  <option value="">-- Chọn lớp --</option>
</select>

<label style="margin-left:20px;"><b>Sắp xếp theo:</b></label>
<select id="sort-filter" disabled>
  <option value="stt">STT (tăng dần)</option>
  <option value="score">Điểm (tăng dần)</option>
</select>

<table id="scoreTable">
  <thead>
    <tr>
      <th>STT</th>
      <th>Tên học sinh</th>
      <th>Lớp</th>
      <th>Điểm</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="missingStudents" class="missing-box">
  <h3>Danh sách học sinh chưa làm bài</h3>
  <ul id="missingList"></ul>
</div>

<script>
const API_URL = "YOUR_WEB_APP_URL_HERE";

let allData = [];

// ----------------------------------------------------
// 1) Tải dữ liệu
// ----------------------------------------------------
fetch(API_URL)
  .then(res => res.json())
  .then(data => {
    allData = data.map(item => ({
      ...item,
      stt: Number(item.stt),
      score: Number(item.score)
    }));
    loadClassList(allData);
  })
  .catch(err => console.error("Lỗi tải dữ liệu:", err));


// ----------------------------------------------------
// 2) Danh sách lớp
// ----------------------------------------------------
function loadClassList(data) {
  const select = document.getElementById("lop-filter");

  const uniqueClasses = [...new Set(data.map(d => d.lop.toString()))];
  uniqueClasses.forEach(lop => {
    const op = document.createElement("option");
    op.value = lop;
    op.textContent = lop;
    select.appendChild(op);
  });

  // Chỉ chạy khi chọn lớp
  select.onchange = applyFilters;

  document.getElementById("sort-filter").onchange = applyFilters;
}


// ----------------------------------------------------
// 3) Áp dụng bộ lọc + sắp xếp
// ----------------------------------------------------
function applyFilters() {
  const lop = document.getElementById("lop-filter").value;
  const sort = document.getElementById("sort-filter").value;

  const table = document.getElementById("scoreTable");
  const missingBox = document.getElementById("missingStudents");

  // Nếu CHƯA chọn lớp → ẨN mọi thứ
  if (lop === "") {
    table.style.display = "none";
    missingBox.style.display = "none";
    document.getElementById("sort-filter").disabled = true;
    return;
  }

  // Khi đã chọn lớp → mở khóa sort + hiển thị bảng
  document.getElementById("sort-filter").disabled = false;
  table.style.display = "table";

  let filtered = allData.filter(d => d.lop.toString() === lop);

  // Sắp xếp
  if (sort === "stt") filtered.sort((a, b) => a.stt - b.stt);
  else if (sort === "score") filtered.sort((a, b) => a.score - b.score);

  renderTable(filtered);
  detectMissingStudents(filtered);
}


// ----------------------------------------------------
// 4) Hiển thị bảng
// ----------------------------------------------------
function renderTable(data) {
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  data.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.stt}</td>
      <td>${item.ten}</td>
      <td>${item.lop}</td>
      <td>${item.score}</td>
    `;
    tbody.appendChild(tr);
  });
}


// ----------------------------------------------------
// 5) Danh sách chưa làm bài
// ----------------------------------------------------
function detectMissingStudents(data) {
  const box = document.getElementById("missingStudents");
  const list = document.getElementById("missingList");

  list.innerHTML = "";
  box.style.display = "none";

  if (data.length === 0) return;

  const maxSTT = Math.max(...data.map(i => i.stt));
  const existed = new Set(data.map(i => i.stt));

  const missing = [];
  for (let i = 1; i <= maxSTT; i++) {
    if (!existed.has(i)) missing.push(i);
  }

  if (missing.length === 0) return;

  box.style.display = "block";
  missing.forEach(stt => {
    const li = document.createElement("li");
    li.textContent = "STT " + stt;
    list.appendChild(li);
  });
}
</script>

</body>
</html>
