<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bảng điểm học sinh</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 28px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th { background: #f2f2f2; cursor: pointer; }

    select {
      padding: 8px;
      font-size: 16px;
      margin-left: 10px;
    }

    .missing-box {
      margin-top: 25px;
      padding: 15px;
      border: 2px dashed red;
      background: #ffecec;
    }
  </style>
</head>
<body>

<h1>Bảng điểm học sinh</h1>

<label><b>Lọc theo lớp:</b></label>
<select id="lop-filter">
  <option value="all">Tất cả</option>
</select>

<label style="margin-left:20px;"><b>Sắp xếp theo:</b></label>
<select id="sort-filter">
  <option value="stt">STT (tăng dần)</option>
  <option value="score">Điểm (tăng dần)</option>
</select>

<table id="scoreTable">
  <thead>
    <tr>
      <th>STT</th>
      <th>Tên học sinh</th>
      <th>Lớp</th>
      <th>Điểm</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="missingStudents" class="missing-box" style="display:none;">
  <h3>Danh sách học sinh chưa làm bài</h3>
  <ul id="missingList"></ul>
</div>

<script>
const API_URL = "YOUR_WEB_APP_URL_HERE";

let allData = [];

// ----------------------------------------------------
// 1) Tải dữ liệu từ Google Apps Script
// ----------------------------------------------------
fetch(API_URL)
  .then(response => response.json())
  .then(data => {
    allData = data;
    loadClassList(data);
    renderTable(data);
  })
  .catch(err => console.error("Lỗi tải dữ liệu:", err));


// ----------------------------------------------------
// 2) Tạo danh sách lớp
// ----------------------------------------------------
function loadClassList(data) {
  const select = document.getElementById("lop-filter");

  const uniqueClasses = [...new Set(data.map(item => item.lop.toString()))];
  uniqueClasses.forEach(lop => {
    const option = document.createElement("option");
    option.value = lop;
    option.textContent = lop;
    select.appendChild(option);
  });

  select.addEventListener("change", applyFilters);
  document.getElementById("sort-filter").addEventListener("change", applyFilters);
}


// ----------------------------------------------------
// 3) Áp dụng bộ lọc & sắp xếp
// ----------------------------------------------------
function applyFilters() {
  const lop = document.getElementById("lop-filter").value;
  const sortType = document.getElementById("sort-filter").value;

  let filtered = [...allData];

  if (lop !== "all") {
    filtered = filtered.filter(item => item.lop.toString() === lop);
  }

  if (sortType === "stt") {
    filtered.sort((a, b) => Number(a.stt) - Number(b.stt));
  } else if (sortType === "score") {
    filtered.sort((a, b) => Number(a.score) - Number(b.score));
  }

  renderTable(filtered);
  detectMissingStudents(filtered);
}


// ----------------------------------------------------
// 4) Hiển thị bảng điểm
// ----------------------------------------------------
function renderTable(data) {
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  data.forEach(item => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${item.stt}</td>
      <td>${item.ten}</td>
      <td>${item.lop}</td>
      <td>${item.score}</td>
    `;
    tbody.appendChild(row);
  });
}


// ----------------------------------------------------
// 5) Tìm học sinh chưa làm bài
//   → STT bị thiếu trong danh sách
// ----------------------------------------------------
function detectMissingStudents(data) {
  const list = document.getElementById("missingList");
  list.innerHTML = "";

  if (data.length === 0) {
    document.getElementById("missingStudents").style.display = "none";
    return;
  }

  const totalStudents = Math.max(...data.map(i => Number(i.stt)));
  const existing = new Set(data.map(i => Number(i.stt)));

  let missing = [];
  for (let i = 1; i <= totalStudents; i++) {
    if (!existing.has(i)) missing.push(i);
  }

  if (missing.length === 0) {
    document.getElementById("missingStudents").style.display = "none";
    return;
  }

  document.getElementById("missingStudents").style.display = "block";
  missing.forEach(stt => {
    const li = document.createElement("li");
    li.textContent = "STT " + stt;
    list.appendChild(li);
  });
}
</script>

</body>
</html>
