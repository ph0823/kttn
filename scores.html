<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bảng điểm học sinh</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f8f8f8; }
    h1 { font-size: 26px; }

    select { padding: 8px; font-size: 15px; margin-right: 10px; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 20px;
      display: none;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }

    th { background: #eee; user-select:none; cursor:pointer; }

    .missing-box {
      margin-top: 20px;
      padding: 12px;
      background:#fff4f4;
      border-left: 4px solid #d9534f;
      display:none;
    }

    .duplicate td {
      background: #ffe9e9;
    }
  </style>
</head>
<body>

<h1>Bảng điểm học sinh</h1>

<label><b>Lọc theo lớp:</b></label>
<select id="lopFilter">
  <option value="">-- Chọn lớp --</option>
</select>

<label><b>Sắp xếp theo:</b></label>
<select id="sortFilter" disabled>
  <option value="stt">STT (tăng dần)</option>
  <option value="score">Điểm (tăng dần)</option>
</select>

<table id="scoreTable">
  <thead>
    <tr>
      <th>STT</th>
      <th>Tên học sinh</th>
      <th>Lớp</th>
      <th>Điểm</th>
      <th>Thời gian</th>
      <th>Số lần</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="missingBox" class="missing-box">
  <h3>Danh sách học sinh chưa làm bài</h3>
  <ul id="missingList"></ul>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyAFbKjEZlA0RmAChAsHWirbeWAK7RwzBNYEAQb4O4tLytTOjoAevXlhDNA3ANtwDcN/exec";
const STUDENT_URL = "./data/students.json";

let allScores = [];
let allStudents = [];
let duplicateMap = {};

async function loadAll() {
  try {
    const scoreRes = await fetch(API_URL);
    const raw = await scoreRes.json();
    allScores = (raw.data || raw).map(r => ({
      stt: Number(r.stt),
      ten: r.ten,
      lop: r.lop,
      score: r.score === "" ? null : Number(r.score),
      timestamp: r.timestamp || r.time || ""
    }));

    // tải danh sách học sinh chính thức
    const stuRes = await fetch(STUDENT_URL);
    allStudents = await stuRes.json();

    buildDuplicateMap();
    loadClassList();
  } catch (e) {
    console.error(e);
    alert("Không thể tải dữ liệu!");
  }
}

function buildDuplicateMap() {
  duplicateMap = {};
  allScores.forEach(r => {
    const key = `${r.lop}|${r.stt}`;
    duplicateMap[key] = (duplicateMap[key] || 0) + 1;
  });
}

function loadClassList() {
  const select = document.getElementById("lopFilter");
  const classes = [...new Set(allScores.map(x => x.lop))].sort();

  classes.forEach(c => {
    const op = document.createElement("option");
    op.value = c;
    op.textContent = c;
    select.appendChild(op);
  });

  select.onchange = applyFilters;
  document.getElementById("sortFilter").onchange = applyFilters;
}

function applyFilters() {
  const lop = document.getElementById("lopFilter").value;
  const sort = document.getElementById("sortFilter").value;

  const table = document.getElementById("scoreTable");
  const missingBox = document.getElementById("missingBox");

  if (!lop) {
    table.style.display = "none";
    missingBox.style.display = "none";
    document.getElementById("sortFilter").disabled = true;
    return;
  }

  document.getElementById("sortFilter").disabled = false;
  table.style.display = "table";

  let filtered = allScores.filter(x => x.lop === lop);

  if (sort === "stt") {
    filtered.sort((a, b) => a.stt - b.stt);
  } else if (sort === "score") {
    filtered.sort((a, b) => {
      const sa = a.score ?? Infinity;
      const sb = b.score ?? Infinity;
      return sa - sb || a.stt - b.stt;
    });
  }

  renderTable(filtered);
  detectMissingStudents(filtered, lop);
}

function renderTable(data) {
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  data.forEach(r => {
    const tr = document.createElement("tr");
    const key = `${r.lop}|${r.stt}`;
    const times = duplicateMap[key] || 1;

    if (times > 1) tr.classList.add("duplicate");

    tr.innerHTML = `
      <td>${r.stt}</td>
      <td>${r.ten}</td>
      <td>${r.lop}</td>
      <td>${r.score ?? ""}</td>
      <td>${r.timestamp}</td>
      <td>${times}</td>
    `;
    tbody.appendChild(tr);
  });
}

function detectMissingStudents(scoreData, lop) {
  const missingBox = document.getElementById("missingBox");
  const list = document.getElementById("missingList");
  list.innerHTML = "";

  const classStudents = allStudents.filter(s => String(s["LƠP"]).trim() === lop);

  const submitted = new Set(scoreData.map(s => s.stt));
  const missing = classStudents.filter(s => !submitted.has(Number(s.STT)));

  if (missing.length === 0) {
    missingBox.style.display = "none";
    return;
  }

  missingBox.style.display = "block";

  missing.forEach(s => {
    const li = document.createElement("li");
    li.textContent = `STT ${s.STT} — ${s.TEN}`;
    list.appendChild(li);
  });
}

loadAll();
</script>

</body>
</html>
