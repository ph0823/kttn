<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B·∫£ng ƒëi·ªÉm h·ªçc sinh</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 28px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      display: none; /* ·∫®N b·∫£ng khi ch∆∞a ch·ªçn l·ªõp */
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    th { background: #f2f2f2; }

    /* T√¥ m√†u xen k·∫Ω */
    tbody tr:nth-child(odd) {
      background: #fafafa;
    }

    select {
      padding: 8px;
      font-size: 16px;
      margin-left: 10px;
    }

    .missing-box {
      margin-top: 15px;
      padding: 12px;
      border: 2px dashed #d9534f;
      background: #fff0f0;
      display: none;
    }

    /* highlight h·ªçc sinh n·ªôp nhi·ªÅu l·∫ßn */
    tr.duplicate td {
      background: #ffe6e6;
    }

    .count-badge {
      display: inline-block;
      min-width: 26px;
      padding: 2px 6px;
      text-align: center;
      border-radius: 12px;
      background: #f3f3f3;
      font-weight: 600;
    }

    .controls { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  </style>
</head>
<body>

<h1>B·∫£ng ƒëi·ªÉm h·ªçc sinh</h1>

<div class="controls">
  <label><b>L·ªçc theo l·ªõp:</b></label>
  <select id="lop-filter">
    <option value="">-- Ch·ªçn l·ªõp --</option>
  </select>

  <label style="margin-left:10px;"><b>S·∫Øp x·∫øp theo:</b></label>
  <select id="sort-filter" disabled>
    <option value="stt">STT (tƒÉng d·∫ßn)</option>
    <option value="score">ƒêi·ªÉm (tƒÉng d·∫ßn)</option>
  </select>

  <div style="margin-left:auto; font-size:14px;">
    <span>Ghi ch√∫: </span>
    <span style="margin-left:6px;">D√≤ng m√†u ƒë·ªè = n·ªôp nhi·ªÅu l·∫ßn</span>
  </div>
</div>

<table id="scoreTable" aria-label="B·∫£ng ƒëi·ªÉm">
  <thead>
    <tr>
      <th>STT</th>
      <th>T√™n h·ªçc sinh</th>
      <th>L·ªõp</th>
      <th>ƒêi·ªÉm</th>
      <th>Th·ªùi gian</th>
      <th>S·ªë l·∫ßn</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="missingStudents" class="missing-box" aria-live="polite">
  <h3>Danh s√°ch h·ªçc sinh ch∆∞a l√†m b√†i</h3>
  <ul id="missingList"></ul>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyAFbKjEZlA0RmAChAsHWirbeWAK7RwzBNYEAQb4O4tLytTOjoAevXlhDNA3ANtwDcN/exec";

let allData = [];
let duplicateMap = {};

// -------------------- Format th·ªùi gian --------------------
function formatTimestamp(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  if (isNaN(d)) return ts;

  let hh = String(d.getHours()).padStart(2, "0");
  let mm = String(d.getMinutes()).padStart(2, "0");
  let ss = String(d.getSeconds()).padStart(2, "0");
  let dd = String(d.getDate()).padStart(2, "0");
  let mo = String(d.getMonth() + 1).padStart(2, "0");
  let yy = String(d.getFullYear()).slice(2);

  return `${hh}:${mm}:${ss} ${dd}-${mo}-${yy}`;
}

// -------------------- T·∫£i d·ªØ li·ªáu --------------------
fetch(API_URL)
  .then(res => res.json())
  .then(result => {
    const data = result.data || result;

    allData = data.map(item => ({
      ...item,
      stt: Number(item.stt) || 0,
      score: item.score === "" ? null : Number(item.score),
      timestamp: item.timestamp || item.time || item.Th·ªùi_gian || item.Thoi_gian || ""
    }));

    // L·∫≠p map s·ªë l·∫ßn n·ªôp (trong d·ªØ li·ªáu g·ªëc, ch∆∞a l·ªçc l·∫ßn ƒë·∫ßu)
    buildDuplicateMap(allData);

    // üëâ Gi·ªØ b√†i l√†m ƒë·∫ßu ti√™n
    let firstMap = {};
    allData.forEach(r => {
      const key = `${r.lop}|${r.stt}`;
      const time = new Date(r.timestamp).getTime();

      if (!firstMap[key] || time < new Date(firstMap[key].timestamp).getTime()) {
        firstMap[key] = r;
      }
    });

    // Ch·ªâ gi·ªØ b·∫£n ghi n·ªôp ƒë·∫ßu ti√™n
    allData = Object.values(firstMap);

    // T·∫°o danh s√°ch l·ªõp
    loadClassList(allData);
  })
  .catch(() => alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ Google Sheet!"));

// -------------------- Duplicate Map --------------------
function buildDuplicateMap(data) {
  duplicateMap = {};
  data.forEach(r => {
    const key = `${r.lop}|${r.stt}`;
    duplicateMap[key] = (duplicateMap[key] || 0) + 1;
  });
}

// -------------------- Danh s√°ch l·ªõp --------------------
function loadClassList(data) {
  const select = document.getElementById("lop-filter");
  const uniqueClasses = [...new Set(data.map(d => d.lop))].sort();

  uniqueClasses.forEach(lop => {
    const op = document.createElement("option");
    op.value = lop;
    op.textContent = lop;
    select.appendChild(op);
  });

  select.onchange = applyFilters;
  document.getElementById("sort-filter").onchange = applyFilters;
}

// -------------------- L·ªçc + s·∫Øp x·∫øp --------------------
function applyFilters() {
  const lop = document.getElementById("lop-filter").value;
  const sort = document.getElementById("sort-filter").value;

  const table = document.getElementById("scoreTable");
  const box = document.getElementById("missingStudents");

  if (!lop) {
    table.style.display = "none";
    box.style.display = "none";
    document.getElementById("sort-filter").disabled = true;
    return;
  }

  table.style.display = "table";
  document.getElementById("sort-filter").disabled = false;

  let filtered = allData.filter(r => r.lop === lop);

  if (sort === "stt") {
    filtered.sort((a, b) => a.stt - b.stt);
  } else if (sort === "score") {
    filtered.sort((a, b) => {
      let A = a.score ?? 999;
      let B = b.score ?? 999;
      return A - B;
    });
  }

  renderTable(filtered);
  detectMissingStudents(filtered);
}

// -------------------- Render b·∫£ng --------------------
function renderTable(data) {
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  data.forEach(row => {
    const key = `${row.lop}|${row.stt}`;
    const times = duplicateMap[key] || 1;

    const tr = document.createElement("tr");
    if (times > 1) tr.classList.add("duplicate");

    tr.innerHTML = `
      <td>${row.stt}</td>
      <td>${escapeHtml(row.ten || "")}</td>
      <td>${escapeHtml(row.lop)}</td>
      <td>${row.score ?? ""}</td>
      <td>${formatTimestamp(row.timestamp)}</td>
      <td><span class="count-badge">${times}</span></td>
    `;

    tbody.appendChild(tr);
  });
}

// -------------------- T√¨m h·ªçc sinh ch∆∞a l√†m b√†i --------------------
function detectMissingStudents(filtered) {
  const box = document.getElementById("missingStudents");
  const list = document.getElementById("missingList");

  list.innerHTML = "";
  box.style.display = "none";

  if (!filtered.length) return;

  const maxSTT = Math.max(...filtered.map(x => x.stt));
  const existing = new Set(filtered.map(x => x.stt));

  let missing = [];
  for (let i = 1; i <= maxSTT; i++) {
    if (!existing.has(i)) missing.push(i);
  }

  if (!missing.length) return;

  box.style.display = "block";
  missing.forEach(m => {
    const li = document.createElement("li");
    li.textContent = "STT " + m;
    list.appendChild(li);
  });
}

// -------------------- Escape HTML --------------------
function escapeHtml(text) {
  return String(text).replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}
</script>

</body>
</html>
