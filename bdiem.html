<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bảng điểm học sinh</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f8f8f8; }
    h1 { font-size: 26px; }

    select { padding: 8px; font-size: 15px; margin-right: 10px; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 20px;
      display: none;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }

    th { background: #eee; user-select:none; cursor:pointer; }

    .missing-box {
      margin-top: 20px;
      padding: 12px;
      background:#fff4f4;
      border-left: 4px solid #d9534f;
      display:none;
    }

    .duplicate td {
      background: #ffe9e9 !important;
    }
  </style>
</head>
<body>

<h1>Bảng điểm học sinh</h1>

<label><b>Lọc theo lớp:</b></label>
<select id="lopFilter">
  <option value="">-- Chọn lớp --</option>
</select>

<label><b>Sắp xếp theo:</b></label>
<select id="sortFilter" disabled>
  <option value="stt">STT (tăng dần)</option>
  <option value="score">Điểm (tăng dần)</option>
</select>

<table id="scoreTable">
  <thead>
    <tr>
      <th>STT</th>
      <th>Tên học sinh</th>
      <th>Lớp</th>
      <th>Điểm</th>
      <th>Thời gian</th>
      <th>Số lần</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="missingBox" class="missing-box">
  <h3>Danh sách học sinh chưa làm bài</h3>
  <ul id="missingList"></ul>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyAFbKjEZlA0RmAChAsWIrbeWAK7RwzBNYEAQb4O4tLytTOjoAevXlhDNA3ANtwDcN/exec";
const STUDENT_URL = "data/students.json";

let allScores = [];
let allStudents = [];
let duplicateMap = {};
let autoRefresh = null;

// -------------------------------------
// KHỞI TẠO DANH SÁCH LỚP
// -------------------------------------
function loadFixedClasses() {
  const classes = [];
  for (let i = 1; i <= 10; i++) classes.push(`7.${i}`);

  const select = document.getElementById("lopFilter");
  classes.forEach(c => {
    const op = document.createElement("option");
    op.value = c;
    op.textContent = c;
    select.appendChild(op);
  });

  select.onchange = handleClassChange;
  document.getElementById("sortFilter").onchange = applyFilters;
}

// -------------------------------------
// TẢI DỮ LIỆU ĐIỂM + DANH SÁCH HỌC SINH
// -------------------------------------
async function loadAll() {
  try {
    const scoreRes = await fetch(API_URL, { cache: "no-store" });
    const raw = await scoreRes.json();

    allScores = (raw.data || raw).map(r => ({
      stt: Number(r.stt),
      ten: r.ten,
      lop: r.lop,
      score: r.score === "" ? null : Number(r.score),
      timestamp: r.timestamp || r.time || ""
    }));

    const stuRes = await fetch(STUDENT_URL);
    allStudents = await stuRes.json();

    buildDuplicateMap();
    applyFilters(); 

  } catch (e) {
    console.error(e);
    alert("Không thể tải dữ liệu!");
  }
}

// -------------------------------------
// Xử lý Chọn Lớp
// -------------------------------------
function handleClassChange() {
  const lop = document.getElementById("lopFilter").value;

  if (autoRefresh) clearInterval(autoRefresh);

  if (lop) {
    loadAll();
    autoRefresh = setInterval(loadAll, 45000);
  } else {
    document.getElementById("scoreTable").style.display = "none";
    document.getElementById("missingBox").style.display = "none";
  }
}

// -------------------------------------
// Lập map trùng
// -------------------------------------
function buildDuplicateMap() {
  duplicateMap = {};
  allScores.forEach(s => {
    const key = s.ten + "_" + s.lop;
    if (!duplicateMap[key]) duplicateMap[key] = 0;
    duplicateMap[key]++;
  });
}

// -------------------------------------
// LỌC + HIỂN THỊ DỮ LIỆU
// -------------------------------------
function applyFilters() {
  const lop = document.getElementById("lopFilter").value;
  if (!lop) return;

  document.getElementById("sortFilter").disabled = false;

  // Học sinh trong lớp
  const studentsInClass = allStudents.filter(s => s.lop === lop);

  // Điểm học sinh trong lớp
  let scores = allScores.filter(s => s.lop === lop);

  // Lấy lần làm đầu tiên
  const firstTry = {};
  scores.forEach(s => {
    const key = s.ten;
    if (!firstTry[key]) firstTry[key] = s;
  });

  let finalScores = Object.values(firstTry);

  // Sắp xếp
  const sortType = document.getElementById("sortFilter").value;
  finalScores.sort((a, b) => {
    if (sortType === "score") return (a.score ?? 0) - (b.score ?? 0);
    return a.stt - b.stt;
  });

  renderTable(finalScores);
  renderMissing(studentsInClass, finalScores);
}

// -------------------------------------
// HIỂN THỊ BẢNG ĐIỂM
// -------------------------------------
function renderTable(list) {
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  list.forEach(item => {
    const tr = document.createElement("tr");

    const key = item.ten + "_" + item.lop;
    if (duplicateMap[key] > 1) tr.classList.add("duplicate");

    tr.innerHTML = `
      <td>${item.stt}</td>
      <td>${item.ten}</td>
      <td>${item.lop}</td>
      <td>${item.score ?? ""}</td>
      <td>${item.timestamp}</td>
      <td>${duplicateMap[key] || 1}</td>
    `;

    tbody.appendChild(tr);
  });

  document.getElementById("scoreTable").style.display = "table";
}

// -------------------------------------
// HỌC SINH CHƯA LÀM BÀI
// -------------------------------------
function renderMissing(students, scored) {
  const box = document.getElementById("missingBox");
  const list = document.getElementById("missingList");
  list.innerHTML = "";

  const scoredNames = scored.map(s => s.ten);
  const missing = students.filter(s => !scoredNames.includes(s.ten));

  if (missing.length === 0) {
    box.style.display = "none";
    return;
  }

  missing.forEach(m => {
    const li = document.createElement("li");
    li.textContent = `${m.stt}. ${m.ten}`;
    list.appendChild(li);
  });

  box.style.display = "block";
}

// -------------------------------------
// KHỞI CHẠY
// -------------------------------------
loadFixedClasses();
</script>

</body>
</html>
